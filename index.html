<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Monitoring Stok Gudang</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background: #f6fafd; }
    .fade-in { animation: fadeIn 0.4s ease-in-out; }
    @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }
  </style>
</head>
<body class="min-h-screen flex flex-col">
  <!-- Navbar -->
  <nav class="bg-white shadow sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 flex items-center justify-between h-16">
      <div class="flex items-center gap-3">
        <span class="bg-blue-100 text-blue-600 rounded-lg p-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg></span>
        <span class="font-bold text-lg text-blue-800">Monitoring Stok Gudang</span>
      </div>
      <span class="hidden md:block text-sm text-gray-500">Terhubung Google Sheets</span>
    </div>
  </nav>

  <!-- Dashboard -->
  <section class="max-w-7xl mx-auto px-4 py-6 grid grid-cols-1 sm:grid-cols-3 gap-6">
    <div class="bg-gradient-to-br from-blue-500 to-blue-700 text-white rounded-xl p-6 text-center shadow fade-in">
      <div class="text-xs uppercase tracking-wide mb-2">Total Produk</div>
      <div class="text-3xl font-extrabold" id="totalProducts">-</div>
    </div>
    <div class="bg-gradient-to-br from-green-400 to-green-600 text-white rounded-xl p-6 text-center shadow fade-in">
      <div class="text-xs uppercase tracking-wide mb-2">Total Stok</div>
      <div class="text-3xl font-extrabold" id="totalStock">-</div>
    </div>
    <div class="bg-gradient-to-br from-purple-500 to-indigo-700 text-white rounded-xl p-6 text-center shadow fade-in">
      <div class="text-xs uppercase tracking-wide mb-2">Lokasi Gudang</div>
      <div class="text-3xl font-extrabold" id="totalLocations">-</div>
    </div>
  </section>

  <!-- Filter & Search -->
  <section class="max-w-7xl mx-auto px-4 py-2 flex flex-col md:flex-row gap-3 md:items-center md:justify-between">
    <div class="relative flex-1">
      <svg class="absolute left-3 top-2.5 h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
      </svg>
      <input id="search" placeholder="Cari produk, ID, atau lokasi..." class="pl-10 pr-4 py-2 w-full rounded-md border border-gray-200 focus:ring focus:ring-blue-100 transition bg-white shadow-sm" />
    </div>
    <div class="flex gap-2">
      <select id="locationFilter" class="border border-gray-200 rounded-md px-3 py-2 text-sm bg-white shadow-sm focus:ring focus:ring-blue-100">
        <option value="">Semua Lokasi</option>
      </select>
      <button id="refreshBtn" class="px-3 py-2 rounded-md bg-blue-600 text-white font-semibold shadow hover:bg-blue-700 transition">Refresh</button>
      <button id="downloadPDF" class="px-3 py-2 rounded-md bg-red-500 text-white font-semibold shadow hover:bg-red-600 transition">Unduh PDF</button>
    </div>
  </section>

  <!-- Table -->
  <section class="max-w-7xl mx-auto px-4 py-4">
    <div class="overflow-x-auto rounded-lg shadow border bg-white">
      <table id="stockTable" class="w-full text-sm">
        <thead class="bg-blue-50">
          <tr>
            <th class="p-3 text-left font-semibold text-gray-700">ID</th>
            <th class="p-3 text-left font-semibold text-gray-700">Produk</th>
            <th class="p-3 text-left font-semibold text-gray-700">Palet</th>
            <th class="p-3 text-left font-semibold text-gray-700">Lokasi</th>
            <th class="p-3 text-left font-semibold text-gray-700">Stok</th>
          </tr>
        </thead>
        <tbody id="tableBody" class="divide-y">
          <tr>
            <td colspan="5" class="p-6 text-center text-gray-500">Memuat data...</td>
          </tr>
        </tbody>
      </table>
    </div>
    <div class="flex flex-col sm:flex-row justify-between items-center text-sm text-gray-500 mt-4 gap-2">
      <div>Menampilkan <span id="showing">0</span> dari <span id="totalItems">0</span></div>
      <div class="flex gap-2">
        <button id="prevPage" class="px-3 py-1 border rounded disabled:opacity-40 bg-white hover:bg-blue-50 transition">Prev</button>
        <button id="nextPage" class="px-3 py-1 border rounded disabled:opacity-40 bg-white hover:bg-blue-50 transition">Next</button>
      </div>
    </div>
    <div class="text-right text-xs text-gray-400 mt-2">Terakhir update: <span id="updateTime">-</span></div>
  </section>

  <!-- Footer -->
  <footer class="bg-white border-t mt-auto py-4">
    <div class="max-w-7xl mx-auto text-center text-gray-500 text-sm">
      &copy; 2025 Monitoring Stok Gudang. All rights reserved.
    </div>
  </footer>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    const SHEET_ID = "1kWuc2yMEAeeHQkC5sVvGdNEwH8YLpif2aIQL8qzF3ds";
    const SHEET_NAME = "Sheet1";
    const API_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${SHEET_NAME}`;
    let allData = [], filteredData = [], currentPage = 1, perPage = 10;

    function loadData(){
      fetch(API_URL).then(r=>r.text()).then(txt=>{
        const json = JSON.parse(txt.substr(47).slice(0,-2));
        const rows = json.table.rows;

        const lastUpdateCell = rows[0]?.c[6]?.v || "-";
        document.getElementById('updateTime').textContent = lastUpdateCell;

        allData = rows.slice(1).map(r=>({
          id: r.c[0]?.v||'',
          nama: r.c[1]?.v||'',
          palet: r.c[2]?.v||'',
          lokasi: r.c[3]?.v||'',
          stok: parseInt(r.c[4]?.v||0)
        }));

        updateDashboard();
        applyFilters();
      }).catch(()=>{
        document.getElementById('tableBody').innerHTML='<tr><td colspan="5" class="p-6 text-center text-red-500">Gagal memuat data, periksa koneksi atau izin Google Sheet</td></tr>';
      });
    }

    function updateDashboard(){
      document.getElementById('totalProducts').textContent = allData.length;
      document.getElementById('totalStock').textContent = allData.reduce((s,d)=>s+d.stok,0);
      document.getElementById('totalLocations').textContent = new Set(allData.map(d=>d.lokasi)).size;
      let locSel = document.getElementById('locationFilter');
      locSel.innerHTML='<option value="">Semua Lokasi</option>';
      Array.from(new Set(allData.map(d=>d.lokasi))).sort().forEach(l=>{
        locSel.innerHTML+=`<option>${l}</option>`;
      });
    }

    function applyFilters(){
      const q=document.getElementById('search').value.toLowerCase();
      const loc=document.getElementById('locationFilter').value;
      filteredData = allData.filter(d=>{
        const matchQ = d.id.toLowerCase().includes(q)||d.nama.toLowerCase().includes(q)||d.lokasi.toLowerCase().includes(q);
        const matchLoc = !loc || d.lokasi===loc;
        return matchQ && matchLoc;
      });
      currentPage=1;
      renderTable();
    }

    function renderTable(){
      let body=document.getElementById('tableBody');
      if(filteredData.length===0){body.innerHTML='<tr><td colspan=5 class="p-6 text-center text-gray-400">Tidak ada data</td></tr>';return;}
      let start=(currentPage-1)*perPage,end=start+perPage;
      let pageData=filteredData.slice(start,end);
      body.innerHTML='';
      pageData.forEach(d=>{
        body.innerHTML+=`<tr class="hover:bg-blue-50 fade-in">
          <td class="p-3">${d.id}</td>
          <td class="p-3">${d.nama}</td>
          <td class="p-3">${d.palet}</td>
          <td class="p-3">${d.lokasi}</td>
          <td class="p-3">${d.stok}</td>
        </tr>`;
      });
      document.getElementById('showing').textContent=pageData.length;
      document.getElementById('totalItems').textContent=filteredData.length;
      document.getElementById('prevPage').disabled=currentPage===1;
      document.getElementById('nextPage').disabled=end>=filteredData.length;
    }

    function downloadPDF(){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({orientation:'landscape'});
      const title = 'Laporan Stok Gudang';
      const lastUpdate = document.getElementById('updateTime').textContent;

      doc.setFontSize(16);
      doc.text(title, 14, 15);
      doc.setFontSize(10);
      doc.text(`Terakhir Update: ${lastUpdate}`, 14, 22);

      let rows = [['ID','Produk','Palet','Lokasi','Stok']];
      filteredData.forEach(d=>{
        rows.push([d.id, d.nama, d.palet, d.lokasi, d.stok.toString()]);
      });
      let y = 30;
      rows.forEach(r=>{
        doc.text(r.join(' | '),14,y);
        y+=7;
        if(y>190){doc.addPage();y=20;}
      });
      doc.save('Laporan_Stok_Gudang.pdf');
    }

    document.addEventListener('DOMContentLoaded',()=>{
      loadData();
      document.getElementById('refreshBtn').onclick=loadData;
      document.getElementById('search').oninput=applyFilters;
      document.getElementById('locationFilter').onchange=applyFilters;
      document.getElementById('prevPage').onclick=()=>{if(currentPage>1){currentPage--;renderTable();}};
      document.getElementById('nextPage').onclick=()=>{if(currentPage*perPage<filteredData.length){currentPage++;renderTable();}};
      document.getElementById('downloadPDF').onclick=downloadPDF;
    });
  </script>
</body>
</html>